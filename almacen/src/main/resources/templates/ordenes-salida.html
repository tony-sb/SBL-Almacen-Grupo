<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orden de Salidas - Sistema de Almacén</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/dashboard.css}" rel="stylesheet">
    <link th:href="@{/css/ordenes-salida.css}" rel="stylesheet">
</head>
<body class="dashboard-body">
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard">
            <img th:src="@{/img/logo.jpg}" alt="Logo" height="40" class="d-inline-block align-text-top">
            Sistema de Almacén
        </a>
        <div class="navbar-nav ms-auto">
            <div class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle me-1"></i>
                    <span class="user-info" sec:authentication="name"></span>
                </a>
                <ul class="dropdown-menu">
                    <li><span class="dropdown-item-text user-role" sec:authentication="principal.authorities"></span></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="bi bi-speedometer2"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/ordenes-abastecimiento">
                            <i class="bi bi-cart-plus"></i>
                            Orden de Abastecimiento
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/ordenes-salida">
                            <i class="bi bi-box-arrow-up"></i>
                            Orden de Salidas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/inventario">
                            <i class="bi bi-box-seam"></i>
                            Inventario
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link" href="/usuarios">
                            <i class="bi bi-people"></i>
                            Usuarios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/proveedores">
                            <i class="bi bi-truck"></i>
                            Proveedores
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/productos">
                            <i class="bi bi-box"></i>
                            Productos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/beneficiario">
                            <i class="bi bi-heart"></i>
                            Beneficiarios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/estadisticas">
                            <i class="bi bi-bar-chart-line"></i>
                            Reportes Gráficos
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 main-content px-md-4">
            <!-- Título Centrado -->
            <div class="page-header mt-4 text-center">
                <h1 class="page-title">Órdenes de Salida de Productos</h1>
                <!-- Botón Nueva Orden -->
                <div class="mt-3">
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#nuevaSalidaModal">
                        <i class="bi bi-plus-circle me-1"></i>Nueva Orden de Salida
                    </button>
                </div>
            </div>

            <!-- Filtros de Búsqueda -->
            <div class="search-header">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <div class="user-info-section">
                            <p class="mb-0">
                                <i class="bi bi-person me-1"></i>
                                <strong>Usuario:</strong>
                                <span sec:authentication="name" class="ms-1">almacenero</span>
                            </p>
                        </div>
                    </div>

                    <div class="col-md-4 text-center">
                        <div class="periodo-section">
                            <div class="row g-2 justify-content-center">
                                <div class="periodo-section">
                                    <p class="mb-0">
                                        <i class="bi bi-calendar me-1"></i>
                                        <strong>Periodo Actual:</strong>
                                        <span id="fechaActual" class="ms-1"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 text-end">
                        <div class="input-group">
                            <input type="text" class="form-control" id="busqueda"
                                   placeholder="Buscar por DNI o Nº trámite"
                                   th:value="${busqueda}">
                            <button type="button" class="btn btn-primary" id="btn-filtrar">
                                <i class="bi bi-search me-1"></i>Buscar
                            </button>
                            <button type="button" class="btn btn-secondary" id="btn-limpiar">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas de éxito/error -->
            <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>Salida registrada exitosamente
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span th:text="${param.error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Tabla de Órdenes de Salida -->
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Órdenes de Salida Registradas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped table-bordered">
                            <thead class="table-dark">
                            <tr>
                                <th>Nº O.S.</th>
                                <th>Fecha</th>
                                <th>DNI Usuario</th>
                                <th>Nº de Trámite</th>
                                <th>Cant. Producto</th>
                                <th>Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="salida : ${ordenesSalida}">
                                <td th:text="${salida.numeroOrden}">010-2025</td>
                                <td th:text="${#temporals.format(salida.fechaSalida, 'dd-MM-yyyy')}">06-10-2025</td>
                                <td th:text="${salida.dniUsuario}">101010101010</td>
                                <td th:text="${salida.numeroTramite}">xxxxxxxxxxxx</td>
                                <td th:text="${salida.cantidadProductos}">17614221</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <!-- Ícono de impresión (azul) -->
                                        <button type="button" class="btn btn-outline-primary"
                                                th:data-orden="${salida.numeroOrden}"
                                                onclick="ordenSalidaManager.imprimirSalida(this.getAttribute('data-orden'))"
                                                title="Imprimir">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                        <!-- Ícono de editar (amarillo) -->
                                        <button type="button" class="btn btn-outline-warning"
                                                th:data-id="${salida.id}"
                                                onclick="ordenSalidaManager.editarSalida(this.getAttribute('data-id'))"
                                                title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <!-- Ícono de eliminar (rojo) -->
                                        <button type="button" class="btn btn-outline-danger btn-eliminar"
                                                th:data-id="${salida.id}"
                                                th:data-orden="${salida.numeroOrden}"
                                                onclick="ordenSalidaManager.eliminarSalida(this.getAttribute('data-id'), this.getAttribute('data-orden'))"
                                                title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>

                            <!-- Mensaje si no hay órdenes -->
                            <tr th:if="${#lists.isEmpty(ordenesSalida)}">
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox display-6 d-block mb-2"></i>
                                    No hay órdenes de salida registradas
                                    <br>
                                    <button type="button" class="btn btn-success btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#nuevaSalidaModal">
                                        <i class="bi bi-plus-circle me-1"></i>Crear primera orden de salida
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal para Nueva Orden de Salida -->
<div class="modal fade" id="nuevaSalidaModal" tabindex="-1" aria-labelledby="nuevaSalidaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nuevaSalidaModalLabel">
                    <i class="bi bi-box-arrow-up me-2"></i>Nueva Orden de Salida
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- guardar-multiples -->
            <form th:action="@{/ordenes-salida/guardar-multiples}" method="post" id="formSalidaModal" onsubmit="return validarFormularioSalida()">
                <div class="modal-body">
                    <!-- Sección de Fecha -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <strong>Fecha:</strong> <span th:text="${#temporals.format(#temporals.createToday(), 'dd/MM/yyyy')}">xx/xx/xxxx</span>
                        </div>
                    </div>

                    <!-- DATOS DE LA SALIDA -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>DATOS DE LA SALIDA</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="numero-tramite" class="form-label">Nº de O.S.</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control"
                                                   id="numero-tramite-preview"
                                                   value="Se generará automáticamente"
                                                   readonly
                                                   style="background-color: #f8f9fa;">
                                            <span class="input-group-text">
                                                <i class="bi bi-info-circle"
                                                   title="Se generará automáticamente al guardar"></i>
                                            </span>
                                        </div>
                                        <small class="text-muted">Número de orden generado automáticamente</small>

                                        <input type="hidden" id="numero-tramite" name="numeroTramite">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="fecha-salida" class="form-label">Fecha de Salida *</label>
                                        <input type="date" class="form-control" id="fecha-salida" name="fechaSalida"
                                               th:value="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"
                                               required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="user-name" class="form-label">Nombre y Apellidos del usuario *</label>
                                        <input type="text" class="form-control" id="user-name" name="nombreUsuario"
                                               placeholder="Ingrese nombre y apellidos" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="user-dni" class="form-label">DNI *</label>
                                        <input type="text" class="form-control" id="user-dni" name="dniUsuario"
                                               placeholder="Ingrese DNI (8 dígitos)"
                                               pattern="\d{8}"
                                               maxlength="8"
                                               title="El DNI debe tener 8 dígitos"
                                               oninput="validarDniInput(this)"
                                               required>
                                        <small class="form-text">8 dígitos numéricos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Descripción</label>
                                <textarea class="form-control" id="description" name="descripcion"
                                          placeholder="Ingrese descripción de la salida" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- BÚSQUEDA DE PRODUCTOS -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-search me-2"></i>BÚSQUEDA DE PRODUCTOS</h6>
                            <div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarProductoSeleccionado()">
                                    <i class="bi bi-plus-circle me-1"></i>Agregar Producto
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Origen:</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" id="catalog" name="origin" checked>
                                    <label class="form-check-label" for="catalog">DESDE CATALOGO</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="search-term"
                                       placeholder="Cadena de Búsqueda (Cod/Art):"
                                       onkeyup="buscarProductos()">
                            </div>

                            <!-- Tabla de productos para selección -->
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-hover table-striped">
                                    <thead class="table-dark">
                                    <tr>
                                        <th>Elegir</th>
                                        <th>Código</th>
                                        <th>U.Medida</th>
                                        <th>Descripción</th>
                                        <th>Grupo</th>
                                        <th>Stock</th>
                                    </tr>
                                    </thead>
                                    <tbody id="tabla-productos">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- PRODUCTOS SELECCIONADOS -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-cart-check me-2"></i>PRODUCTOS SELECCIONADOS</h6>
                            <div>
                                <span id="contador-productos" class="badge bg-secondary">0 productos</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="30%">Producto</th>
                                        <th width="15%">Código</th>
                                        <th width="15%">Stock</th>
                                        <th width="15%">Cantidad</th>
                                        <th width="10%">Acción</th>
                                    </tr>
                                    </thead>
                                    <tbody id="productos-seleccionados-container">
                                    <!-- Los productos seleccionados aparecerán aquí -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- DETALLES DEL PRODUCTO SELECCIONADO (NS) -->
                    <div class="card mb-4" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-box me-2"></i>DETALLES DEL PRODUCTO SELECCIONADO</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Código:</label>
                                        <input type="text" class="form-control" id="product-code" readonly>
                                        <input type="hidden" id="product-id" name="productoId">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Nombre:</label>
                                        <input type="text" class="form-control" id="product-name" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Stock Disponible:</label>
                                        <input type="text" class="form-control" id="available-stock" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Cantidad *:</label>
                                        <input type="number" class="form-control" id="product-quantity"
                                               name="cantidad" min="1" max="1" value="1" required disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="btn-confirmar-salida">
                        <i class="bi bi-check-circle me-1"></i>Confirmar Salida
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/ordenes-salida.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar el manager
        if (typeof ordenSalidaManager !== 'undefined') {
            ordenSalidaManager.init();
        } else {
            console.error('ordenSalidaManager no está definido');
        }

        // Configurar fecha actual
        const now = new Date();
        const fechaFormateada = now.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        const fechaElement = document.getElementById('fechaActual');
        if (fechaElement) {
            fechaElement.textContent = fechaFormateada;
        }

        // Configurar fecha máxima como hoy
        const hoy = new Date().toISOString().split('T')[0];
        const fechaSalidaInput = document.getElementById('fecha-salida');
        if (fechaSalidaInput) {
            fechaSalidaInput.max = hoy;
        }

        // Verificar si hay orden pendiente para reabrir modal
        verificarOrdenPendiente();

        // Agregar validación de DNI
        const dniInput = document.getElementById('user-dni');
        if (dniInput) {
            dniInput.addEventListener('blur', function() {
                const dni = this.value.trim();
                if (dni.length === 8 && /^\d+$/.test(dni)) {
                    verificarDNI(dni);
                }
            });
        }

        // Limpiar localStorage cuando el modal se cierre manualmente
        const modalElement = document.getElementById('nuevaSalidaModal');
        if (modalElement) {
            modalElement.addEventListener('hidden.bs.modal', function() {
                const datosOrden = localStorage.getItem('ordenPendiente');
                if (datosOrden) {
                    const orden = JSON.parse(datosOrden);
                    if (!orden.ordenPendiente) {
                        localStorage.removeItem('ordenPendiente');
                    }
                }
            });

            modalElement.addEventListener('shown.bs.modal', function() {
                const datosOrden = localStorage.getItem('ordenPendiente');
                if (datosOrden) {
                    const orden = JSON.parse(datosOrden);
                    if (orden.ordenPendiente) {
                        orden.ordenPendiente = false;
                        localStorage.setItem('ordenPendiente', JSON.stringify(orden));
                    }
                }
            });
        }
    });

    function verificarDNI(dni) {
        if (!dni || dni.length !== 8) return;

        console.log('Verificando DNI:', dni);

        fetch(`/ordenes-salida/verificar-dni/${dni}`)
            .then(response => response.json())
            .then(data => {
                console.log('Respuesta DNI:', data);

                if (data.valido) {
                    if (data.existe) {
                        // Si existe, completar automáticamente
                        const nombreInput = document.getElementById('user-name');
                        if (nombreInput) {
                            nombreInput.value = data.nombreCompleto;
                            nombreInput.readOnly = true;
                            nombreInput.style.backgroundColor = '#e9ecef';
                            showAlert('success', `Beneficiario encontrado: ${data.nombreCompleto}`);
                        }
                    } else {
                        // Si no existe, mostrar opción para agregar
                        const nombreInput = document.getElementById('user-name');
                        if (nombreInput) {
                            nombreInput.readOnly = false;
                            nombreInput.style.backgroundColor = '';
                            nombreInput.focus();

                            // Mostrar alerta con opción para agregar beneficiario
                            showAlertWithOption(
                                'warning',
                                'DNI no registrado. ¿Desea agregar este beneficiario?',
                                'Agregar Beneficiario',
                                function() {
                                    guardarDatosOrdenTemporal();
                                    window.location.href = `/beneficiario/formulario-con-redireccion?dni=${dni}`;
                                }
                            );
                        }
                    }
                } else {
                    showAlert('warning', data.mensaje || 'DNI inválido');
                }
            })
            .catch(error => {
                console.error('Error al verificar DNI:', error);
                showAlert('danger', 'Error al conectar con el servidor');
            });
    }

    // Función para guardar datos de orden temporalmente
    function guardarDatosOrdenTemporal() {
        const datosOrden = {
            productoId: document.getElementById('product-id').value,
            cantidad: document.getElementById('product-quantity').value,
            numeroTramite: document.getElementById('numero-tramite').value,
            fechaSalida: document.getElementById('fecha-salida').value,
            descripcion: document.getElementById('description').value,
            nombreUsuario: document.getElementById('user-name').value,
            dniUsuario: document.getElementById('user-dni').value,
            productoCodigo: document.getElementById('product-code').value,
            productNombre: document.getElementById('product-name').value,
            productStock: document.getElementById('available-stock').value,
            ordenPendiente: true,
            timestamp: new Date().getTime()
        };

        localStorage.setItem('ordenPendiente', JSON.stringify(datosOrden));
        console.log('Datos de orden guardados temporalmente:', datosOrden);
    }

    // Función para verificar y reabrir modal si hay orden pendiente
    function verificarOrdenPendiente() {
        const datosOrden = localStorage.getItem('ordenPendiente');
        if (datosOrden) {
            const orden = JSON.parse(datosOrden);

            const ahora = new Date().getTime();
            if (ahora - orden.timestamp < 3600000) {

                setTimeout(() => {
                    showAlert('info', 'Continuando con orden pendiente...');

                    const modal = new bootstrap.Modal(document.getElementById('nuevaSalidaModal'));
                    modal.show();

                    setTimeout(() => {
                        restaurarDatosOrdenCompleta();
                    }, 500);

                }, 1000);
            } else {
                localStorage.removeItem('ordenPendiente');
            }
        }
    }

    // Función mejorada para restaurar todos los datos de la orden
    function restaurarDatosOrdenCompleta() {
        const datosOrden = localStorage.getItem('ordenPendiente');
        if (datosOrden) {
            const orden = JSON.parse(datosOrden);
            console.log('Restaurando datos completos de orden:', orden);

            if (orden.productoId) document.getElementById('product-id').value = orden.productoId;
            if (orden.cantidad) {
                document.getElementById('product-quantity').value = orden.cantidad;
                document.getElementById('product-quantity').disabled = false;
            }
            if (orden.numeroTramite) document.getElementById('numero-tramite').value = orden.numeroTramite;
            if (orden.fechaSalida) document.getElementById('fecha-salida').value = orden.fechaSalida;
            if (orden.descripcion) document.getElementById('description').value = orden.descripcion;
            if (orden.nombreUsuario) document.getElementById('user-name').value = orden.nombreUsuario;
            if (orden.dniUsuario) {
                document.getElementById('user-dni').value = orden.dniUsuario;
                setTimeout(() => validarDniInput(document.getElementById('user-dni')), 100);
            }

            if (orden.productoCodigo) document.getElementById('product-code').value = orden.productoCodigo;
            if (orden.productNombre) document.getElementById('product-name').value = orden.productNombre;
            if (orden.productStock) document.getElementById('available-stock').value = orden.productStock;

            marcarProductoSeleccionado(orden.productoId);

            showAlert('success', 'Orden restaurada. Complete los datos faltantes.');
        }
    }

    // Función para marcar producto como seleccionado en la tabla
    function marcarProductoSeleccionado(productoId) {
        if (!productoId) return;

        setTimeout(() => {
            const radios = document.querySelectorAll(`#tabla-productos input[type="radio"][value="${productoId}"]`);
            if (radios.length > 0) {
                radios[0].checked = true;
                const fila = radios[0].closest('tr');
                if (fila) {
                    fila.classList.add('table-success');
                    fila.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }, 800);
    }

    // Función para mostrar alerta con opción
    function showAlertWithOption(type, message, buttonText, buttonAction) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px;';

        alertDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <i class="bi ${type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
                    ${message}
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-secondary me-2" id="alertCancelBtn">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-sm btn-${type === 'warning' ? 'warning' : 'primary'}" id="alertActionBtn">
                        ${buttonText}
                    </button>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        document.body.appendChild(alertDiv);

        document.getElementById('alertActionBtn').addEventListener('click', function() {
            guardarDatosOrdenTemporal();
            buttonAction();
            const bsAlert = new bootstrap.Alert(alertDiv);
            bsAlert.close();
        });

        document.getElementById('alertCancelBtn').addEventListener('click', function() {
            localStorage.removeItem('ordenPendiente');
            const bsAlert = new bootstrap.Alert(alertDiv);
            bsAlert.close();
            const nombreInput = document.getElementById('user-name');
            if (nombreInput) {
                nombreInput.readOnly = false;
                nombreInput.style.backgroundColor = '';
                nombreInput.focus();
            }
        });

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 15000);
    }

    // Función para mostrar alertas simples
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }

    // Función para validar DNI
    function validarDniInput(input) {
        const dni = input.value;

        if (dni.length === 8 && /^\d+$/.test(dni)) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            return true;
        } else if (dni.length > 0) {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
            return false;
        } else {
            input.classList.remove('is-valid', 'is-invalid');
            return false;
        }
    }

    // Generar número de orden automático
    function generarNumeroOrden() {
        const hoy = new Date();
        const año = hoy.getFullYear();
        const mes = String(hoy.getMonth() + 1).padStart(2, '0');
        const dia = String(hoy.getDate()).padStart(2, '0');
        const timestamp = Date.now();
        const random = Math.floor(Math.random() * 1000);

        const numeroOrden = `OS-${año}${mes}${dia}-${timestamp.toString().slice(-4)}${random.toString().padStart(3, '0')}`;
        return numeroOrden;
    }

    // Validar formulario completo antes de enviar
    function validarFormularioSalida() {
        const dniValido = validarDniInput(document.getElementById('user-dni'));
        const productoSeleccionado = document.getElementById('product-id').value;
        const cantidad = document.getElementById('product-quantity').value;
        const stock = parseInt(document.getElementById('available-stock').value);

        let errores = [];

        if (!dniValido) {
            errores.push('El DNI debe tener 8 dígitos numéricos');
        }

        if (!productoSeleccionado) {
            errores.push('Por favor seleccione un producto');
        }

        if (!cantidad || cantidad <= 0) {
            errores.push('Ingrese una cantidad válida');
        }

        if (parseInt(cantidad) > stock) {
            errores.push(`La cantidad no puede ser mayor al stock disponible (${stock})`);
        }

        if (errores.length > 0) {
            alert('Error:\n' + errores.join('\n'));
            return false;
        }

        const numeroOrden = generarNumeroOrden();
        document.getElementById('numero-tramite-preview').value = numeroOrden;
        document.getElementById('numero-tramite').value = numeroOrden;

        console.log('Número de orden generado:', numeroOrden);
        return true;
    }
</script>
<script>
    // Variables globales
    let productosSeleccionados = [];
    let productoSeleccionadoActual = null;

    // Función para cargar productos en la tabla
    function cargarProductosEnTabla() {
        fetch('/ordenes-salida/productos')
            .then(response => response.json())
            .then(productos => {
                const tabla = document.getElementById('tabla-productos');
                if (!tabla) return;

                tabla.innerHTML = '';

                productos.forEach(producto => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td>
                            <input type="radio" name="productoSeleccionado"
                                   value="${producto.id}"
                                   onclick="seleccionarProductoParaMultiples(
                                       '${producto.id}',
                                       '${producto.codigo || ''}',
                                       '${producto.nombre}',
                                       ${producto.cantidad}
                                   )">
                        </td>
                        <td>${producto.codigo || 'N/A'}</td>
                        <td>${producto.unidadMedida || 'UNIDAD'}</td>
                        <td>${producto.nombre}</td>
                        <td>${producto.grupo || 'GENERAL'}</td>
                        <td class="text-center">
                            <span class="badge ${producto.cantidad <= 5 ? 'bg-warning' : 'bg-success'}">
                                ${producto.cantidad}
                            </span>
                        </td>
                    `;
                    tabla.appendChild(fila);
                });

                // Seleccionar automáticamente el primer producto
                if (productos.length > 0) {
                    const primerProducto = productos[0];
                    seleccionarProductoParaMultiples(
                        primerProducto.id,
                        primerProducto.codigo || '',
                        primerProducto.nombre,
                        primerProducto.cantidad
                    );
                }
            })
            .catch(error => console.error('Error al cargar productos:', error));
    }

    // Función para seleccionar producto (MÚLTIPLES)
    function seleccionarProductoParaMultiples(id, codigo, nombre, stock) {
        productoSeleccionadoActual = {
            id: id,
            codigo: codigo,
            nombre: nombre,
            stock: parseInt(stock)
        };

        // Resaltar la fila seleccionada
        const filas = document.querySelectorAll('#tabla-productos tr');
        filas.forEach(fila => {
            fila.classList.remove('table-success');
            const radio = fila.querySelector('input[type="radio"]');
            if (radio && radio.value === id) {
                radio.checked = true;
                fila.classList.add('table-success');
            }
        });

        // Actualizar campos individuales
        document.getElementById('product-id').value = id;
        document.getElementById('product-code').value = codigo;
        document.getElementById('product-name').value = nombre;
        document.getElementById('available-stock').value = stock;

        // Activar cantidad
        const cantidadInput = document.getElementById('product-quantity');
        if (cantidadInput) {
            cantidadInput.disabled = false;
            cantidadInput.max = stock;
            cantidadInput.value = 1;
        }

        console.log('Producto seleccionado para múltiples:', productoSeleccionadoActual);
    }

    // Función para agregar producto a la lista
    function agregarProductoSeleccionado() {
        if (!productoSeleccionadoActual) {
            alert('Por favor, seleccione un producto de la tabla primero');
            return;
        }

        // Verificar si ya está en la lista
        if (productosSeleccionados.some(p => p.id === productoSeleccionadoActual.id)) {
            alert('Este producto ya está en la lista');
            return;
        }

        // Agregar a la lista
        const nuevoProducto = {
            ...productoSeleccionadoActual,
            cantidad: 1
        };

        productosSeleccionados.push(nuevoProducto);
        actualizarTablaProductosSeleccionados();

        // Mostrar mensaje de éxito
        showAlert('success', `Producto "${productoSeleccionadoActual.nombre}" agregado a la lista`);

        console.log('Productos en la lista:', productosSeleccionados);
    }

    // Función para actualizar la tabla de productos seleccionados
    function actualizarTablaProductosSeleccionados() {
        const container = document.getElementById('productos-seleccionados-container');
        if (!container) return;

        container.innerHTML = '';

        productosSeleccionados.forEach((producto, index) => {
            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td class="text-center">${index + 1}</td>
                <td>${producto.nombre}</td>
                <td>${producto.codigo}</td>
                <td class="text-center">
                    <span class="badge ${producto.stock <= 5 ? 'bg-warning' : 'bg-success'}">
                        ${producto.stock}
                    </span>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm cantidad-producto"
                           data-producto-id="${producto.id}"
                           min="1" max="${producto.stock}"
                           value="${producto.cantidad}"
                           onchange="actualizarCantidadProducto('${producto.id}', this.value)"
                           style="width: 80px;">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-outline-danger btn-sm btn-eliminar-producto"
                            onclick="removerProductoDeLista('${producto.id}')"
                            title="Eliminar producto">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            container.appendChild(fila);
        });

        // Actualizar contador
        actualizarContadorProductos();
    }

    // Función para actualizar cantidad de un producto
    function actualizarCantidadProducto(productoId, cantidad) {
        const cantidadNum = parseInt(cantidad);
        const producto = productosSeleccionados.find(p => p.id === productoId);

        if (producto) {
            // Validar stock
            if (cantidadNum > producto.stock) {
                alert(`La cantidad no puede ser mayor al stock disponible (${producto.stock})`);
                // Corregir el valor
                const input = document.querySelector(`input[data-producto-id="${productoId}"]`);
                if (input) input.value = producto.stock;
                producto.cantidad = producto.stock;
            } else if (cantidadNum < 1) {
                alert('La cantidad debe ser al menos 1');
                const input = document.querySelector(`input[data-producto-id="${productoId}"]`);
                if (input) input.value = 1;
                producto.cantidad = 1;
            } else {
                producto.cantidad = cantidadNum;
            }
        }

        actualizarContadorProductos();
    }

    // Función para remover producto de la lista
    function removerProductoDeLista(productoId) {
        if (confirm('¿Está seguro de eliminar este producto de la lista?')) {
            // Eliminar de la lista interna
            productosSeleccionados = productosSeleccionados.filter(p => p.id !== productoId);

            // Actualizar tabla
            actualizarTablaProductosSeleccionados();

            showAlert('info', 'Producto eliminado de la lista');
        }
    }

    // Actualizar contador de productos
    function actualizarContadorProductos() {
        const contadorElement = document.getElementById('contador-productos');
        if (contadorElement) {
            contadorElement.textContent = `${productosSeleccionados.length} producto(s)`;
            contadorElement.className = productosSeleccionados.length > 0 ?
                'badge bg-success' : 'badge bg-secondary';
        }
    }

    // Función de búsqueda
    function buscarProductos() {
        const termino = document.getElementById('search-term').value.toLowerCase();
        const filas = document.querySelectorAll('#tabla-productos tr');

        filas.forEach(fila => {
            const textoFila = fila.textContent.toLowerCase();
            if (textoFila.includes(termino)) {
                fila.style.display = '';
            } else {
                fila.style.display = 'none';
            }
        });
    }

    // Preparar datos para enviar al backend (MÚLTIPLES)
    function prepararDatosEnvioMultiples() {
        const form = document.getElementById('formSalidaModal');

        // Limpiar campos ocultos anteriores
        document.querySelectorAll('input[name="productoIds"]').forEach(el => el.remove());
        document.querySelectorAll('input[name="cantidades"]').forEach(el => el.remove());

        // Agregar campos para cada producto
        productosSeleccionados.forEach(producto => {
            // Campo para producto ID
            const inputProductoId = document.createElement('input');
            inputProductoId.type = 'hidden';
            inputProductoId.name = 'productoIds';
            inputProductoId.value = producto.id;
            form.appendChild(inputProductoId);

            // Campo para cantidad
            const inputCantidad = document.createElement('input');
            inputCantidad.type = 'hidden';
            inputCantidad.name = 'cantidades';
            inputCantidad.value = producto.cantidad;
            form.appendChild(inputCantidad);
        });

        console.log('Datos preparados para envío:', productosSeleccionados);
    }

    // Modificar la función validarFormularioSalida para MÚLTIPLES productos
    function validarFormularioSalida() {
        console.log('Validando formulario con MÚLTIPLES productos...');

        // 1. Validar DNI
        const dniValido = validarDniInput(document.getElementById('user-dni'));

        // 2. Validar que haya productos seleccionados
        if (productosSeleccionados.length === 0) {
            alert('Error: Debe agregar al menos un producto a la lista');
            // Enfocar el botón de agregar producto
            const botonAgregar = document.querySelector('[onclick="agregarProductoSeleccionado()"]');
            if (botonAgregar) botonAgregar.focus();
            return false;
        }

        // 3. Validar cada producto
        let errores = [];

        productosSeleccionados.forEach((producto, index) => {
            if (!producto.cantidad || producto.cantidad < 1) {
                errores.push(`• Producto ${index + 1} (${producto.nombre}): La cantidad debe ser al menos 1`);
            }

            if (producto.cantidad > producto.stock) {
                errores.push(`• Producto ${index + 1} (${producto.nombre}): La cantidad (${producto.cantidad}) excede el stock disponible (${producto.stock})`);
            }
        });

        if (!dniValido) {
            errores.push('• El DNI debe tener 8 dígitos numéricos');
        }

        if (errores.length > 0) {
            alert('Errores encontrados:\n\n' + errores.join('\n'));
            return false;
        }

        // 4. Preparar datos para envío
        prepararDatosEnvioMultiples();

        // 5. Generar número de orden
        const numeroOrden = generarNumeroOrden();
        document.getElementById('numero-tramite-preview').value = numeroOrden;
        document.getElementById('numero-tramite').value = numeroOrden;

        console.log('Formulario validado con éxito');
        console.log('Productos a enviar:', productosSeleccionados);

        return true;
    }

    // Inicializar cuando se abre el modal
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('nuevaSalidaModal');
        if (modal) {
            modal.addEventListener('show.bs.modal', function() {
                console.log('Modal abierto - inicializando múltiples productos');

                // Reiniciar variables
                productosSeleccionados = [];
                productoSeleccionadoActual = null;

                // Limpiar tabla de productos seleccionados
                const container = document.getElementById('productos-seleccionados-container');
                if (container) container.innerHTML = '';

                // Actualizar contador
                actualizarContadorProductos();

                // Cargar productos en la tabla
                setTimeout(() => {
                    cargarProductosEnTabla();
                }, 300);
            });

            modal.addEventListener('hidden.bs.modal', function() {
                console.log('Modal cerrado');
                // Opcional: mantener los productos para edición
            });
        }
    });

    // Función para mostrar alertas (si no la tienes)
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }
</script>
</body>
</html>