<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<!-- Fragmento para formulario de orden de salida -->
<div th:fragment="formulario-orden-salida" class="orden-salida-form-container">

    <!-- Sección de Fecha -->
    <div class="card mb-4">
        <div class="card-body">
            <strong>Fecha:</strong> <span th:text="${#temporals.format(#temporals.createToday(), 'dd/MM/yyyy')}">xx/xx/xxxx</span>
        </div>
    </div>

    <!-- DATOS DE LA SALIDA -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>DATOS DE LA SALIDA</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="numero-tramite" class="form-label">Nº de O.S.</label>
                        <input type="text" class="form-control"
                               id="numero-tramite-preview"
                               value="Se generará automáticamente"
                               readonly
                               style="background-color: #f8f9fa;">
                        <small class="text-muted">Número de orden generado automáticamente</small>
                        <!-- Campo oculto para el backend -->
                        <input type="hidden" id="numero-tramite" name="numeroTramite">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="fecha-salida" class="form-label">Fecha de Salida *</label>
                        <input type="date" class="form-control" id="fecha-salida" name="fechaSalida"
                               th:value="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"
                               required>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="user-name" class="form-label">Nombre y Apellidos del usuario *</label>
                        <input type="text" class="form-control" id="user-name" name="nombreUsuario"
                               placeholder="Ingrese nombre y apellidos" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="user-dni" class="form-label">DNI *</label>
                        <input type="text" class="form-control" id="user-dni" name="dniUsuario"
                               placeholder="Ingrese DNI (8 dígitos)"
                               pattern="\d{8}"
                               maxlength="8"
                               title="El DNI debe tener 8 dígitos"
                               required>
                        <small class="form-text">8 dígitos numéricos</small>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Descripción</label>
                <textarea class="form-control" id="description" name="descripcion"
                          placeholder="Ingrese descripción de la salida" rows="3"></textarea>
            </div>
        </div>
    </div>

    <!-- BÚSQUEDA DE PRODUCTOS -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-search me-2"></i>BÚSQUEDA DE PRODUCTOS</h6>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Origen:</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" id="catalog" name="origin" checked>
                    <label class="form-check-label" for="catalog">DESDE CATALOGO</label>
                </div>
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" id="search-term"
                       placeholder="Cadena de Búsqueda (Cod/Art):"
                       onkeyup="buscarProductos()">
            </div>

            <!-- Tabla de productos -->
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-hover table-striped">
                    <thead class="table-dark">
                    <tr>
                        <th>Elegir</th>
                        <th>Código</th>
                        <th>U.Medida</th>
                        <th>Descripción</th>
                        <th>Grupo</th>
                        <th>Stock</th>
                    </tr>
                    </thead>
                    <tbody id="tabla-productos">
                    <!-- Los productos se cargarán dinámicamente -->
                    <tr th:each="producto : ${productos}">
                        <td>
                            <input type="radio" name="productoSeleccionado"
                                   th:value="${producto.id}"
                                   th:onclick="|seleccionarProducto(${producto.id}, '${producto.codigo}', '${producto.nombre}', ${producto.cantidad})|">
                        </td>
                        <td th:text="${producto.codigo}"></td>
                        <td th:text="${producto.unidadMedida}"></td>
                        <td th:text="${producto.nombre}"></td>
                        <td th:text="${producto.categoria}"></td>
                        <td>
                            <span class="badge"
                                  th:class="${producto.cantidad <= producto.stockMinimo ? 'bg-warning' : 'bg-success'}">
                                <span th:text="${producto.cantidad}"></span>
                            </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DETALLES DEL PRODUCTO SELECCIONADO -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-box me-2"></i>DETALLES DEL PRODUCTO SELECCIONADO</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Código:</label>
                        <input type="text" class="form-control" id="product-code" readonly>
                        <input type="hidden" id="product-id" name="productoId">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Nombre:</label>
                        <input type="text" class="form-control" id="product-name" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Stock Disponible:</label>
                        <input type="text" class="form-control" id="available-stock" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Cantidad *:</label>
                        <input type="number" class="form-control" id="product-quantity"
                               name="cantidad" min="1" value="1" required disabled>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Validación de DNI -->
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Nota:</strong> El número de orden (Nº O.S.) se generará automáticamente al guardar.
    </div>

    <!-- Script para funcionalidad del formulario -->
    <script>
        // Variables globales
        let productosSeleccionados = [];
        let numeroOrdenBase = '';

        // Generar número de orden base al cargar
        function generarNumeroOrdenBase() {
            const hoy = new Date();
            const año = hoy.getFullYear();
            const mes = String(hoy.getMonth() + 1).padStart(2, '0');
            const dia = String(hoy.getDate()).padStart(2, '0');

            // Base: OS-YYYYMMDD-XXX
            numeroOrdenBase = `OS-${año}${mes}${dia}-`;
            console.log('Número base generado:', numeroOrdenBase);
        }

        function buscarProductos() {
            const termino = document.getElementById('search-term').value.toLowerCase();
            const filas = document.querySelectorAll('#tabla-productos tr');

            filas.forEach(fila => {
                const textoFila = fila.textContent.toLowerCase();
                if (textoFila.includes(termino)) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
        }

        function seleccionarProducto(id, codigo, nombre, stock) {
            document.getElementById('product-id').value = id;
            document.getElementById('product-code').value = codigo;
            document.getElementById('product-name').value = nombre;
            document.getElementById('available-stock').value = stock;

            const cantidadInput = document.getElementById('product-quantity');
            cantidadInput.disabled = false;
            cantidadInput.max = stock;
            cantidadInput.value = 1;

            // Resaltar la fila seleccionada
            const filas = document.querySelectorAll('#tabla-productos tr');
            filas.forEach(fila => {
                fila.classList.remove('table-success');
                const radio = fila.querySelector('input[type="radio"]');
                if (radio && radio.checked) {
                    fila.classList.add('table-success');
                }
            });

            console.log('Producto seleccionado:', { id, codigo, nombre, stock });
        }

        // Validar DNI en tiempo real
        function validarDNI() {
            const dniInput = document.getElementById('user-dni');
            const dni = dniInput.value;

            if (dni.length === 8 && /^\d+$/.test(dni)) {
                dniInput.classList.remove('is-invalid');
                dniInput.classList.add('is-valid');
                return true;
            } else if (dni.length > 0) {
                dniInput.classList.remove('is-valid');
                dniInput.classList.add('is-invalid');
                return false;
            } else {
                dniInput.classList.remove('is-valid', 'is-invalid');
                return false;
            }
        }

        // Validar formulario completo antes de enviar
        function validarFormulario() {
            const dniValido = validarDNI();
            const productoSeleccionado = document.getElementById('product-id').value;
            const cantidad = document.getElementById('product-quantity').value;
            const stock = parseInt(document.getElementById('available-stock').value);

            let errores = [];

            if (!dniValido) {
                errores.push('El DNI debe tener 8 dígitos numéricos');
            }

            if (!productoSeleccionado) {
                errores.push('Por favor seleccione un producto');
            }

            if (!cantidad || cantidad <= 0) {
                errores.push('Ingrese una cantidad válida');
            }

            if (parseInt(cantidad) > stock) {
                errores.push(`La cantidad no puede ser mayor al stock disponible (${stock})`);
            }

            if (errores.length > 0) {
                alert('Error:\n' + errores.join('\n'));
                return false;
            }

            // Generar número de orden final antes de enviar
            generarNumeroOrdenFinal();
            return true;
        }

        // Generar número de orden final con timestamp
        function generarNumeroOrdenFinal() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            const numeroOrden = `${numeroOrdenBase}${timestamp.toString().slice(-3)}${random.toString().padStart(3, '0')}`;

            document.getElementById('numero-tramite-preview').value = numeroOrden;
            document.getElementById('numero-tramite').value = numeroOrden;

            console.log('Número de orden generado:', numeroOrden);
        }

        // Inicializar cuando se carga el modal
        document.addEventListener('DOMContentLoaded', function() {
            // Generar número base
            generarNumeroOrdenBase();

            // Establecer fecha máxima como hoy
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha-salida').max = hoy;

            // Validar DNI en tiempo real
            document.getElementById('user-dni').addEventListener('input', validarDNI);

            // Seleccionar el primer producto por defecto
            const primeraFila = document.querySelector('#tabla-productos tr');
            if (primeraFila) {
                const radio = primeraFila.querySelector('input[type="radio"]');
                if (radio) {
                    const id = radio.value;
                    const codigo = primeraFila.cells[1].textContent;
                    const nombre = primeraFila.cells[3].textContent;
                    const stock = parseInt(primeraFila.cells[5].querySelector('span').textContent);
                    seleccionarProducto(id, codigo, nombre, stock);
                    radio.checked = true;
                }
            }

            console.log('Formulario de orden de salida inicializado');
        });
    </script>
</div>
</body>
</html>