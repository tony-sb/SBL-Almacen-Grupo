<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Beneficiario - Orden de Salida</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Header -->
            <div class="card border-primary mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-person-plus me-2"></i>
                        Agregar Nuevo Beneficiario
                    </h4>
                    <p class="mb-0 mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        Complete los datos del beneficiario para continuar con la orden de salida
                    </p>
                </div>
            </div>

            <!-- Formulario -->
            <div class="card">
                <div class="card-body">
                    <!-- Mensajes -->
                    <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                        <i class="bi bi-check-circle me-2"></i>
                        <span th:text="${success}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span th:text="${error}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <!-- Información de contexto -->
                    <div th:if="${redirigirDesdeOrden}" class="alert alert-info">
                        <h6><i class="bi bi-clipboard-check me-2"></i>Información de la Orden Pendiente</h6>
                        <p class="mb-0">
                            Después de registrar al beneficiario, continuará con la orden de salida.
                            Los datos de la orden han sido guardados temporalmente.
                        </p>
                    </div>

                    <!-- Formulario -->
                    <form th:action="@{/beneficiario/guardar-y-continuar}"
                          method="post"
                          th:object="${beneficiario}"
                          id="formBeneficiario">

                        <!-- Campos ocultos para datos de orden -->
                        <input type="hidden" name="productoId" th:value="${productoId}">
                        <input type="hidden" name="cantidad" th:value="${cantidad}">
                        <input type="hidden" name="numeroTramite" th:value="${numeroTramite}">
                        <input type="hidden" name="fechaSalida" th:value="${fechaSalida}">
                        <input type="hidden" name="descripcion" th:value="${descripcion}">

                        <!-- DNI (pre-llenado) -->
                        <div class="mb-3">
                            <label for="dni" class="form-label">DNI <span class="text-danger">*</span></label>
                            <input type="text" th:field="*{dni}" class="form-control"
                                   id="dni" placeholder="Ingrese el DNI" maxlength="8"
                                   th:readonly="${beneficiario.dni != null}">
                            <small class="text-muted">8 dígitos numéricos</small>
                        </div>

                        <!-- Nombres -->
                        <div class="mb-3">
                            <label for="nombres" class="form-label">Nombres <span class="text-danger">*</span></label>
                            <input type="text" th:field="*{nombres}" class="form-control"
                                   id="nombres" placeholder="Ingrese los nombres" required>
                        </div>

                        <!-- Apellidos -->
                        <div class="mb-3">
                            <label for="apellidos" class="form-label">Apellidos <span class="text-danger">*</span></label>
                            <input type="text" th:field="*{apellidos}" class="form-control"
                                   id="apellidos" placeholder="Ingrese los apellidos" required>
                        </div>

                        <!-- Teléfono -->
                        <div class="mb-3">
                            <label for="telefono" class="form-label">Teléfono/Celular</label>
                            <input type="text" th:field="*{telefono}" class="form-control"
                                   id="telefono" placeholder="Ej: 987654321 o 074-1234567">
                        </div>

                        <!-- Dirección -->
                        <div class="mb-3">
                            <label for="direccion" class="form-label">Dirección <span class="text-danger">*</span></label>
                            <textarea th:field="*{direccion}" class="form-control"
                                      id="direccion" rows="2"
                                      placeholder="Ingrese la dirección completa" required></textarea>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <a th:href="@{/ordenes-salida}" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-1"></i>Cancelar Orden
                            </a>

                            <div>
                                <button type="reset" class="btn btn-outline-secondary me-2">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Limpiar
                                </button>

                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-save me-1"></i>Guardar y Continuar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Información adicional -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6><i class="bi bi-lightbulb me-2"></i>Recomendaciones</h6>
                    <ul class="mb-0">
                        <li>Verifique que el DNI sea correcto antes de guardar</li>
                        <li>Complete todos los campos obligatorios marcados con <span class="text-danger">*</span></li>
                        <li>Los datos serán guardados en la base de datos para futuras órdenes</li>
                        <li>Después de guardar, continuará con la confirmación de la orden de salida</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Validación del DNI
    document.getElementById('dni').addEventListener('input', function(e) {
        // Solo permitir números
        this.value = this.value.replace(/[^0-9]/g, '');

        // Validar longitud
        if (this.value.length > 8) {
            this.value = this.value.substring(0, 8);
        }
    });

    // Validación del teléfono
    document.getElementById('telefono').addEventListener('input', function(e) {
        let valor = this.value.replace(/[^0-9]/g, '');

        // Si empieza con '9' -> formato de 9 dígitos
        if (valor.startsWith('9') && valor.length === 9) {
            this.value = valor;
        }
        // Si empieza con '0' -> agregar guion después de 3 dígitos
        else if (valor.startsWith('0') && valor.length >= 3) {
            const parte1 = valor.substring(0, 3);
            const parte2 = valor.substring(3);
            this.value = parte1 + (parte2 ? '-' + parte2 : '');
        } else {
            this.value = valor;
        }
    });

    // Prevenir envío si hay errores
    document.getElementById('formBeneficiario').addEventListener('submit', function(e) {
        const dni = document.getElementById('dni').value;
        if (dni.length !== 8) {
            e.preventDefault();
            alert('El DNI debe tener 8 dígitos');
            return false;
        }
        return true;
    });
      // Limpiar localStorage cuando se envíe el formulario
    document.getElementById('formBeneficiario').addEventListener('submit', function() {
        localStorage.removeItem('ordenPendiente');
    });

    // También limpiar si el usuario cancela
    document.querySelector('a[href="/ordenes-salida"]').addEventListener('click', function() {
        localStorage.removeItem('ordenPendiente');
    });
</script>
</body>
</html>